---

- hosts: all
  gather_facts: true
  become: yes
  tasks:

    - name: check if it is Atomic host
      stat: path=/run/ostree-booted
      register: stat_ostree
      always_run: true

    - name: set fact for using Atomic host
      set_fact:
        is_atomic: '{{ stat_ostree.stat.exists }}'

      # we need to install this so the Socket testinfra module
      # can use netcat for testing
    - name: install net-tools
      package:
        name: net-tools
        state: present
      when:
        - not is_atomic

    # why sleep 2? see here: https://github.com/ansible/ansible/issues/14413
    - name: reboot the machine
      shell: sleep 2 && shutdown -r now
      async: 1
      poll: 0

    - name: wait for server to boot
      become: false
      local_action: wait_for port=22 host={{ ansible_default_ipv4.address }} state=started delay=10 timeout=500

    - name: show uptime
      command: uptime
